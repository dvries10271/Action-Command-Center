<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action Command Center - Coaching Command Center</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --text-primary: #e8e8e8;
            --text-secondary: #b8b8b8;
            --accent-blue: #4a7c9e;
            --success-green: #53bf9d;
            --warning-yellow: #ffc94c;
            --error-red: #f94c66;
            --impact-red: #bd4291;
            --border-color: #2a3f5f;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary), #0f0f1e);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Back to Dashboard Button */
        .back-button {
            position: fixed;
            top: 30px;
            left: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .back-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .back-arrow {
            font-size: 18px;
        }

        /* Dashboard Header */
        .dashboard-header {
            text-align: center;
            padding: 80px 20px 30px;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border-bottom: 2px solid var(--border-color);
        }

        .dashboard-title {
            font-size: 48px;
            font-weight: bold;
            background: linear-gradient(135deg, #4a7c9e 0%, #53bf9d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .dashboard-subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
            font-style: italic;
        }

        /* Login Screen */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--bg-primary), #0f0f1e);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        #loginScreen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .login-container {
            background: var(--bg-secondary);
            padding: 3rem 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            border: 2px solid var(--border-color);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--success-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .login-error {
            background: rgba(249, 76, 102, 0.1);
            border: 1px solid var(--error-red);
            color: var(--error-red);
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .login-footer {
            margin-top: 2rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .demo-info {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(74, 124, 158, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .demo-info strong {
            color: var(--accent-blue);
        }

        /* Main App - Initially Hidden */
        #mainApp {
            display: none;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        #mainApp.active {
            display: flex;
        }

        /* App Container */
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--success-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #userName {
            background: linear-gradient(135deg, var(--success-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .icon-btn {
            background: var(--accent-blue);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            position: relative;
            font-size: 1.2rem;
        }

        .icon-btn:hover {
            background: #5a8cae;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 124, 158, 0.4);
        }

        .icon-btn.warning {
            background: var(--warning-yellow);
            color: #333;
        }

        .icon-btn.warning:hover {
            background: #ffdc6c;
        }

        .icon-btn.success {
            background: var(--success-green);
        }

        .icon-btn.success:hover {
            background: #63cfad;
        }

        .tooltip {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .tooltip::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 4px solid rgba(0,0,0,0.9);
        }

        .icon-btn:hover .tooltip {
            opacity: 1;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            transition: color 0.2s;
        }

        .logout-btn:hover {
            color: var(--error-red);
        }

        .btn {
            padding: 0.5rem 1rem;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn:hover {
            background: #5a8cae;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 124, 158, 0.4);
        }

        .btn-success {
            background: var(--success-green);
        }

        .btn-success:hover {
            background: #63cfad;
        }

        .btn-warning {
            background: var(--warning-yellow);
            color: #333;
        }

        /* Stats Bar */
        .stats-bar {
            background: var(--bg-secondary);
            padding: 0.75rem 2rem;
            display: flex;
            gap: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .stat-value {
            font-weight: bold;
            color: var(--accent-blue);
        }

        /* Mission Cards Section */
        .mission-section {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .mission-header {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .mission-header:hover {
            background: rgba(74, 124, 158, 0.1);
        }

        .collapse-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .mission-content {
            padding: 1rem 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            max-height: 500px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .mission-content.collapsed {
            max-height: 0;
            padding: 0 2rem;
        }

        /* Mobile optimization for mission cards */
        @media (max-width: 768px) {
            .mission-content {
                padding: 1rem;
                display: flex;
                flex-direction: column;
                max-height: none;
                overflow: visible;
            }
            
            .mission-content.collapsed {
                max-height: 0;
                overflow: hidden;
                padding: 0 1rem;
            }
        }

        .mission-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--border-color);
            transition: transform 0.3s;
            min-width: 250px;
        }

        .mission-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .mission-card h3 {
            color: var(--accent-blue);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .mission-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.85rem;
        }

        .mission-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .status-complete { background: var(--success-green); }
        .status-progress { background: var(--warning-yellow); color: #333; }
        .status-blocked { background: var(--error-red); }
        .status-not-started { background: #666; }

        .mission-metric {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Main Board */
        .board-container {
            flex: 1;
            padding: 1.5rem;
            overflow-x: auto;
        }

        .board {
            display: flex;
            gap: 1rem;
            min-height: 600px;
        }

        .column {
            background: var(--bg-secondary);
            border-radius: 8px;
            min-width: 320px;
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .column.drag-over {
            background: rgba(74, 124, 158, 0.1);
            border-color: var(--accent-blue);
        }

        .column-header {
            padding: 1rem;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .column-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .column-count {
            background: var(--bg-card);
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.85rem;
        }

        .column-content {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
            min-height: 400px;
        }

        /* Eisenhower Sections */
        .eisenhower-section {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 4px;
            min-height: 80px;
        }

        .section-ui { 
            background: rgba(249, 76, 102, 0.1); 
            border-left: 3px solid var(--error-red); 
        }
        .section-uni { 
            background: rgba(255, 201, 76, 0.1); 
            border-left: 3px solid var(--warning-yellow); 
        }
        .section-nui { 
            background: rgba(74, 124, 158, 0.1); 
            border-left: 3px solid var(--accent-blue); 
        }
        .section-nuni { 
            background: rgba(255, 255, 255, 0.05); 
            border-left: 3px solid #666; 
        }

        .section-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .section-items {
            min-height: 40px;
            padding: 0.25rem;
        }

        /* Signal Column Sections */
        .signal-section {
            margin-bottom: 1.5rem;
        }

        .signal-today {
            background: rgba(83, 191, 157, 0.1);
            padding: 0.75rem;
            border-radius: 4px;
            border: 2px dashed var(--success-green);
            min-height: 150px;
        }

        .signal-week {
            padding: 0.75rem;
            min-height: 100px;
        }

        /* Action Cards */
        .action-card {
            background: var(--bg-card);
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: move;
            transition: all 0.2s;
            border: 1px solid transparent;
            position: relative;
        }

        .action-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border-color: var(--accent-blue);
        }

        .action-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .action-card.high-impact {
            background: linear-gradient(135deg, var(--bg-card), rgba(189, 66, 145, 0.2));
            border-color: var(--impact-red);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .card-title {
            font-size: 0.9rem;
            flex: 1;
            padding-right: 0.5rem;
            font-weight: 500;
        }

        .card-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .action-card:hover .card-actions {
            opacity: 1;
        }

        .card-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .card-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .card-badges {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        .badge {
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            background: var(--bg-secondary);
        }

        .badge-q4 {
            background: var(--accent-blue);
            color: white;
        }

        .badge-warning {
            background: var(--warning-yellow);
            color: #333;
        }

        .badge-delegated {
            background: var(--success-green);
            color: white;
        }

        .badge-domain {
            background: var(--impact-red);
            color: white;
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .card-effort {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .card-score {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .card-source {
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            opacity: 0.7;
        }

        /* Capacity Bar */
        .capacity-container {
            padding: 0 1rem;
            margin-top: 0.5rem;
        }

        .capacity-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .capacity-bar {
            background: var(--bg-primary);
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .capacity-fill {
            height: 100%;
            transition: width 0.5s ease;
            position: relative;
        }

        .capacity-fill.safe {
            background: linear-gradient(90deg, var(--success-green), #4a9d83);
        }

        .capacity-fill.warning {
            background: linear-gradient(90deg, var(--warning-yellow), #ff9f1c);
        }

        .capacity-fill.danger {
            background: linear-gradient(90deg, var(--error-red), #ff6b6b);
        }

        .capacity-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            animation: slideUp 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(74, 124, 158, 0.2);
        }

        .tag-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag-btn {
            padding: 0.4rem 0.8rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag-btn:hover {
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }

        .tag-btn.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .delete-btn {
            background: var(--error-red);
            color: white;
        }

        .delete-btn:hover {
            background: #ff5566;
        }

        /* Footer */
        .footer {
            background: linear-gradient(135deg, #1a1a2e 0%, #0a0a0f 100%);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
            padding: 3rem 2rem 2rem;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .footer-section h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .footer-section p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .footer-links {
            list-style: none;
        }

        .footer-links li {
            margin-bottom: 0.5rem;
        }

        .footer-links a {
            color: rgba(255, 255, 255, 0.6);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: #667eea;
        }

        .status-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .last-sync {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
        }

        .footer-bottom {
            text-align: center;
            padding-top: 2rem;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
        }

        .version-info {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.3);
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--success-green);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideInRight 0.3s;
            display: none;
        }

        .notification.show {
            display: block;
        }

        .notification.error {
            background: var(--error-red);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .back-button {
                top: 15px;
                left: 15px;
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .dashboard-title {
                font-size: 36px;
            }
            
            .dashboard-header {
                padding-top: 70px;
            }

            .header {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.2rem;
                text-align: center;
                width: 100%;
            }

            .header-actions {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
                margin-top: 1rem;
            }

            .header-actions .btn {
                font-size: 0.85rem;
                padding: 0.4rem 0.8rem;
            }

            .stats-bar {
                flex-wrap: wrap;
                justify-content: center;
                padding: 0.5rem 1rem;
            }

            .stat-item {
                min-width: 45%;
                font-size: 0.85rem;
            }

            .mission-section {
                padding: 0;
            }

            .mission-header {
                padding: 0.75rem 1rem;
            }

            .mission-card {
                width: 100%;
                margin-bottom: 0.5rem;
            }

            .board {
                flex-direction: column;
                padding: 0.5rem;
            }

            .column {
                min-width: 100%;
                margin-bottom: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 1rem;
                padding: 1.5rem 1rem;
            }

            .icon-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            
            .tooltip {
                display: none;
            }

            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }
        }

        /* Print styles */
        @media print {
            .back-button, .header-actions, .footer, .modal, .notification {
                display: none !important;
            }
            .board-container {
                padding: 0;
            }
            .column {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            .action-card {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Back to Dashboard Button -->
    <button class="back-button" onclick="goBackToDashboard()">
        <span class="back-arrow">‚Üê</span>
        <span>Back to Dashboard</span>
    </button>

    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <div class="login-header">
                <h1>Action Command Center</h1>
                <p>Sign in to access your action board</p>
            </div>
            
            <form class="login-form" id="loginForm" onsubmit="handleLogin(event)">
                <div class="login-error" id="loginError"></div>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="your@email.com" autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" autocomplete="current-password">
                </div>
                
                <button type="submit" class="btn btn-success" id="loginButton">
                    Sign In
                </button>
            </form>
            
            <div class="login-footer">
                Secure login powered by n8n workflows
            </div>
        </div>
    </div>

    <!-- Main Application (Initially Hidden) -->
    <div id="mainApp">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">Action Command Center</h1>
            <p class="dashboard-subtitle">Transform ideas into measurable action</p>
        </div>

        <div class="app-container">
            <!-- Header -->
            <header class="header">
                <h1>Action Board ‚Ä¢ <span id="userName">Guest</span></h1>
                <div class="header-actions">
                    <button class="icon-btn" onclick="openQuickCapture()" title="Quick Capture (Ctrl+Space)">
                        ‚ûï
                        <span class="tooltip">Quick Capture (Ctrl+Space)</span>
                    </button>
                    <button class="icon-btn" onclick="refreshData()" title="Refresh Data">
                        üîÑ
                        <span class="tooltip">Refresh Data</span>
                    </button>
                    <button class="icon-btn" onclick="toggleStats()" title="View Stats">
                        üìä
                        <span class="tooltip">View Stats</span>
                    </button>
                    <div class="header-user">
                        <span id="userEmail" style="font-size: 0.85rem; color: var(--text-secondary);">user@email.com</span>
                        <button class="logout-btn" onclick="logout()" title="Logout">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Stats Bar -->
            <div class="stats-bar" id="statsBar">
                <div class="stat-item">
                    <span class="stat-label">Weekly Capacity:</span>
                    <span class="stat-value" id="weeklyCapacity">0/40 hrs</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Today's Focus:</span>
                    <span class="stat-value" id="todayFocus">0/3 items</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Q4 Alignment:</span>
                    <span class="stat-value" id="q4Alignment">0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Completion Rate:</span>
                    <span class="stat-value" id="completionRate">0%</span>
                </div>
            </div>

            <!-- Mission Cards Section -->
            <section class="mission-section">
                <div class="mission-header" onclick="toggleMissions()">
                    <h2>üéØ 90-Day Sprint Missions</h2>
                    <span id="quarterInfo" class="quarter-info"></span>
                    <div style="display:flex; gap:1rem; align-items:center;">
                        <button onclick="fetchMissions(); event.stopPropagation();"
                                style="background:none; border:none; color:var(--accent-blue); cursor:pointer;"
                                title="Refresh missions">
                            üîÑ
                        </button>
                        <button class="collapse-btn" id="collapseBtn">‚åÉ</button>
                    </div>
                </div>

                <div class="mission-content" id="missionContent">
                    <!-- Mission cards will be populated by JavaScript -->
                </div>
            </section>

            <!-- Main Board -->
            <div class="board-container">
                <div class="board" id="board">
                    <!-- Columns will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Action Command Center</h4>
                    <p>Your central hub for managing all actions extracted from transformation sessions. Organize tasks across TO DO, IN ACTION, SIGNAL, and NOISE columns.</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Navigation</h4>
                    <ul class="footer-links">
                        <li><a href="https://dvries10271.github.io/Coaching_Command_Center/">Main Dashboard</a></li>
                        <li><a href="https://dvries10271.github.io/session-form-submit/">Transformation Sessions</a></li>
                        <li><a href="https://dvries10271.github.io/Analytics-Dashboard/">Analytics Dashboard</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Resources</h4>
                    <ul class="footer-links">
                        <li><a href="#" onclick="openQuickCapture()">Quick Capture (Ctrl+Space)</a></li>
                        <li><a href="#" onclick="toggleStats()">View Statistics</a></li>
                        <li><a href="#" onclick="refreshData()">Refresh Data</a></li>
                        <li><a href="mailto:danny@dannydevries.com">Support</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>System Status</h4>
                    <div class="status-info">
                        <span class="status-dot"></span>
                        <span>Action Board Active</span>
                    </div>
                    <div class="last-sync">
                        Data sync: Real-time via n8n
                    </div>
                    <div class="last-sync" id="footerLastSync">
                        Last sync: Never
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>¬© 2025 Lead Generation Experts LLC Coaching System. Built With Purpose. All Rights Reserved.</p>
                <p class="version-info">Action Command Center v3.0 | Enhanced September 2025</p>
            </div>
        </footer>

        <!-- Edit Modal (used for both quick capture and edit) -->
        <div class="modal" id="editModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">‚ö° Quick Capture</h2>
                    <button class="modal-close" onclick="closeEditModal()">√ó</button>
                </div>
                
                <div class="form-group">
                    <label>Action Title *</label>
                    <input type="text" class="form-input" id="actionTitle" placeholder="What needs to be done?">
                </div>

                <div class="form-group">
                    <label>Description / Context</label>
                    <textarea class="form-textarea" id="actionDescription" placeholder="Additional details, context from transformation session, etc."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Domain</label>
                        <select class="form-select" id="domainSelect">
                            <option value="Business">üíº Business</option>
                            <option value="Body">üí™ Body</option>
                            <option value="Being">üß† Being</option>
                            <option value="Balance">‚öñÔ∏è Balance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Eisenhower Quadrant</label>
                        <select class="form-select" id="quadrantSelect">
                            <option value="ui">üî• Urgent & Important</option>
                            <option value="uni">‚≠ê Not Urgent & Important</option>
                            <option value="nui">‚ö° Urgent & Not Important</option>
                            <option value="nuni">üí§ Not Urgent & Not Important</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Estimated Hours</label>
                        <input type="number" class="form-input" id="effortHours" placeholder="2.5" step="0.5" min="0.5" max="40">
                    </div>
                    <div class="form-group">
                        <label>Impact Score (0-100)</label>
                        <input type="number" class="form-input" id="impactScore" placeholder="75" min="0" max="100">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Q4 Alignment (%)</label>
                        <input type="number" class="form-input" id="q4Score" placeholder="85" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label>Deadline</label>
                        <input type="date" class="form-input" id="deadline">
                    </div>
                </div>

                <div class="form-group">
                    <label>Transformation Session Source</label>
                    <input type="text" class="form-input" id="sourceSession" placeholder="e.g., Morning Session 2024-01-15">
                </div>

                <div class="form-group">
                    <label>Revelation / Key Insight</label>
                    <textarea class="form-textarea" id="revelation" placeholder="What was revealed about this action?"></textarea>
                </div>

                <div class="form-group">
                    <label>Tags & Context</label>
                    <div class="tag-group">
                        <button class="tag-btn" onclick="toggleTag(this)">Urgent</button>
                        <button class="tag-btn" onclick="toggleTag(this)">Important</button>
                        <button class="tag-btn" onclick="toggleTag(this)">Q4 Goal</button>
                        <button class="tag-btn" onclick="toggleTag(this)">Delegatable</button>
                        <button class="tag-btn" onclick="toggleTag(this)">Blocked</button>
                        <button class="tag-btn" onclick="toggleTag(this)">Waiting</button>
                        <button class="tag-btn" onclick="toggleTag(this)">High Impact</button>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn delete-btn" id="deleteBtn" onclick="deleteCurrentAction()" style="display:none;">üóëÔ∏è Delete</button>
                    <div>
                        <button class="btn" onclick="closeEditModal()">Cancel</button>
                        <button class="btn btn-success" onclick="saveAction()">Save Action</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification -->
        <div class="notification" id="notification"></div>
    </div>

<script>
// Configuration
const CONFIG = {
    API_ENDPOINT: 'https://n8n-production-3280.up.railway.app/webhook',
    DEMO_MODE: false,
    TOKEN_KEY: 'auth_token',
    USER_KEY: 'user_data',
    DEBUG: false
};

// Authentication State
let authToken = null;
let currentUser = null;

// Data structure
let boardData = {
    todo: [],
    inaction: [],
    signal: [],
    noise: [],
    completed: []
};

let currentEditingCard = null;
let actionIdCounter = 100;

// Session timeout variables
let sessionTimeout;
let warningTimeout;

// ============= RESTORED MISSING FUNCTIONS =============

// Authentication header helper
function getAuthHeaders() {
    return {
        'Authorization': `Bearer ${authToken}`
    };
}

// Get selected tags from form
function getSelectedTags() {
    const tags = [];
    document.querySelectorAll('.tag-btn.active').forEach(btn => {
        tags.push(btn.textContent);
    });
    return tags;
}

// Save board data to localStorage (fallback if API fails)
function saveBoardData() {
    try {
        localStorage.setItem('boardData', JSON.stringify(boardData));
        localStorage.setItem('lastSave', new Date().toISOString());
        if (CONFIG.DEBUG) {
            console.log('Board data saved to localStorage');
        }
    } catch (error) {
        console.error('Error saving board data:', error);
    }
}

// Load board data from localStorage
function loadBoardData() {
    try {
        const savedData = localStorage.getItem('boardData');
        if (savedData) {
            boardData = JSON.parse(savedData);
            return true;
        }
    } catch (error) {
        console.error('Error loading board data:', error);
    }
    return false;
}

// Render the board after changes
function renderBoard() {
    // Clear existing cards
    document.querySelectorAll('.action-card').forEach(card => card.remove());
    
    // Re-render all cards
    Object.keys(boardData).forEach(column => {
        boardData[column].forEach(action => {
            addActionCard(action, column, action.zone || action.quadrant);
        });
    });
    
    updateStats();
}

// Sync card movement with API
async function syncCardMove(cardId, newColumn, newQuadrant) {
    try {
        await fetch(`${CONFIG.API_ENDPOINT}/cards/move`, {
            method: 'POST',
            headers: {
                ...getAuthHeaders(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                cardId: cardId,
                newColumn: newColumn,
                newQuadrant: newQuadrant
            })
        });
    } catch (error) {
        console.error('Error syncing card move:', error);
    }
}

// Delete card via API
async function deleteCard(cardId) {
    try {
        const response = await fetch(`${CONFIG.API_ENDPOINT}/cards/delete`, {
            method: 'POST',
            headers: {
                ...getAuthHeaders(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cardId: cardId })
        });
        
        const result = await response.json();
        if (result.success) {
            return true;
        }
    } catch (error) {
        console.error('Error deleting card:', error);
        return false;
    }
}

// Calculate days remaining in quarter
function daysToQuarterEnd(qString) {
    const [q, yr] = qString.replace('-', ' ').trim().split(/\s+/);
    const quarter = q.replace('Q', '');
    const year = parseInt(yr) || new Date().getFullYear();
    
    const now = new Date();
    
    // Special handling for Q4 2025
    if (quarter === '4' && year === 2025) {
        const q4Start = new Date('2025-10-01');
        const q4End = new Date('2025-12-31');
        
        if (now < q4Start) {
            const msPerDay = 24 * 60 * 60 * 1000;
            return -Math.ceil((q4Start - now) / msPerDay);
        } else if (now <= q4End) {
            const msPerDay = 24 * 60 * 60 * 1000;
            return Math.ceil((q4End - now) / msPerDay);
        } else {
            return 0;
        }
    }
    
    // Calculate for other quarters
    const endMonth = { Q1: 2, Q2: 5, Q3: 8, Q4: 11 }[q];
    if (endMonth === undefined) return 0;
    
    const quarterEnd = new Date(Date.UTC(year, endMonth + 1, 0));
    const today = new Date();
    today.setUTCHours(0, 0, 0, 0);
    
    return Math.max(0, Math.ceil((quarterEnd - today) / 864e5));
}

// Extract from Stack Session (placeholder)
function extractFromStack() {
    showNotification('Stack Session extraction coming soon!', 'info');
}

// Weekly Triage (placeholder)
function performWeeklyTriage() {
    showNotification('Weekly Triage coming soon!', 'info');
}

// ============= AUTHENTICATION FUNCTIONS =============

// Check for existing authentication from dashboard
function checkDashboardAuth() {
    const coachingEmail = localStorage.getItem('coaching_user_email');
    const coachingUserData = localStorage.getItem('coaching_user_data');
    
    if (coachingEmail && coachingUserData) {
        try {
            const userData = JSON.parse(coachingUserData);
            currentUser = {
                email: userData.email || coachingEmail,
                name: userData.name || coachingEmail.split('@')[0]
            };
            authToken = localStorage.getItem(CONFIG.TOKEN_KEY) || 'dashboard-token';
            showMainApp();
            return true;
        } catch (error) {
            console.error('Error parsing dashboard user data:', error);
        }
    }
    return false;
}

// Check authentication
function checkAuthentication() {
    const savedToken = localStorage.getItem(CONFIG.TOKEN_KEY);
    const savedUserString = localStorage.getItem(CONFIG.USER_KEY);
    
    if (CONFIG.DEBUG) {
        console.log('Checking authentication...');
        console.log('Saved token:', savedToken);
        console.log('Saved user string:', savedUserString);
    }
    
    if (savedUserString === 'undefined' || savedUserString === 'null') {
        localStorage.removeItem(CONFIG.USER_KEY);
        localStorage.removeItem(CONFIG.TOKEN_KEY);
        document.getElementById('loginScreen').classList.remove('hidden');
        return;
    }
    
    if (savedToken && savedUserString) {
        try {
            authToken = savedToken;
            currentUser = JSON.parse(savedUserString);
            showMainApp();
        } catch (error) {
            console.error('Error parsing saved user data:', error);
            localStorage.removeItem(CONFIG.USER_KEY);
            localStorage.removeItem(CONFIG.TOKEN_KEY);
            document.getElementById('loginScreen').classList.remove('hidden');
        }
    } else {
        document.getElementById('loginScreen').classList.remove('hidden');
    }
}

// Handle login
async function handleLogin(event) {
    event.preventDefault();
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const button = document.getElementById('loginButton');
    const errorDiv = document.getElementById('loginError');
    
    errorDiv.classList.remove('show');
    button.disabled = true;
    button.textContent = 'Signing in...';
    
    try {
        const loginUrl = `${CONFIG.API_ENDPOINT}/auth/login`;
        
        const response = await fetch(loginUrl, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({ email, password })
        });
        
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.indexOf("application/json") !== -1) {
            const data = await response.json();
            
            if (response.ok && data.success) {
                authToken = data.token;
                currentUser = data.user;
                
                localStorage.setItem(CONFIG.TOKEN_KEY, authToken);
                localStorage.setItem(CONFIG.USER_KEY, JSON.stringify(currentUser));
                
                showMainApp();
            } else {
                throw new Error(data.message || data.error || 'Invalid credentials');
            }
        } else {
            const text = await response.text();
            throw new Error('Server returned invalid response. Check n8n workflow.');
        }
    } catch (error) {
        console.error('Login error:', error);
        
        let errorMessage = 'Login failed: ';
        if (error.message.includes('Failed to fetch')) {
            errorMessage += 'Cannot connect to server. Check if n8n workflow is active.';
        } else {
            errorMessage += error.message;
        }
        
        errorDiv.textContent = errorMessage;
        errorDiv.classList.add('show');
        button.disabled = false;
        button.textContent = 'Sign In';
    }
}

// Show main app
function showMainApp() {
    if (!currentUser || !currentUser.email) {
        console.error('Invalid user data, redirecting to login');
        logout();
        return;
    }
    
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.add('active');
    
    document.getElementById('userName').textContent = currentUser.name || currentUser.email.split('@')[0];
    document.getElementById('userEmail').textContent = currentUser.email;
    
    initializeApp();
}

// Logout
function logout() {
    localStorage.removeItem(CONFIG.TOKEN_KEY);
    localStorage.removeItem(CONFIG.USER_KEY);
    
    authToken = null;
    currentUser = null;
    
    document.getElementById('mainApp').classList.remove('active');
    document.getElementById('loginScreen').classList.remove('hidden');
    
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('loginError').classList.remove('show');
}

// ============= NAVIGATION FUNCTIONS =============

// Go back to dashboard
function goBackToDashboard() {
    window.location.href = 'https://dvries10271.github.io/Coaching_Command_Center/';
}

// Update footer sync time
function updateFooterSync() {
    const now = new Date();
    const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const footerSync = document.getElementById('footerLastSync');
    if (footerSync) {
        footerSync.textContent = 'Last sync: ' + timeString;
    }
}

// ============= INITIALIZATION =============

// Initialize app after login
function initializeApp() {
    initializeBoard();
    loadUserCards();
    setupEventListeners();
    updateStats();
    fetchMissions();
    updateFooterSync();
}

// Initialize board columns
function initializeBoard() {
    const board = document.getElementById('board');
    board.innerHTML = '';

    // TO-DO Column with Eisenhower sections
    const todoColumn = createColumn('TO-DO', 'todo');
    todoColumn.style.minWidth = '350px';
    const todoContent = todoColumn.querySelector('.column-content');
    
    ['ui', 'uni', 'nui', 'nuni'].forEach(quadrant => {
        const section = document.createElement('div');
        section.className = `eisenhower-section section-${quadrant}`;
        section.dataset.quadrant = quadrant;
        
        const labels = {
            'ui': 'üî• URGENT & IMPORTANT',
            'uni': '‚≠ê NOT URGENT & IMPORTANT', 
            'nui': '‚ö° URGENT & NOT IMPORTANT',
            'nuni': 'üí§ NOT URGENT & NOT IMPORTANT'
        };
        
        section.innerHTML = `
            <div class="section-label">${labels[quadrant]}</div>
            <div class="section-items" data-drop-zone="todo-${quadrant}"></div>
        `;
        
        todoContent.appendChild(section);
    });
    
    board.appendChild(todoColumn);

    // IN ACTION Column with capacity bar
    const inActionColumn = createColumn('IN ACTION', 'inaction');
    const capacityHtml = `
        <div class="capacity-container">
            <div class="capacity-label">Weekly Capacity</div>
            <div class="capacity-bar">
                <div class="capacity-fill safe" id="capacityFill" style="width: 0%">
                    <span class="capacity-text">0/40 hrs</span>
                </div>
            </div>
        </div>
    `;
    inActionColumn.querySelector('.column-header').insertAdjacentHTML('afterend', capacityHtml);
    board.appendChild(inActionColumn);

    // SIGNAL Column with Today/This Week sections
    const signalColumn = createColumn('SIGNAL', 'signal');
    const signalContent = signalColumn.querySelector('.column-content');
    signalContent.innerHTML = `
        <div class="signal-section">
            <div class="section-label">TODAY (MAX 3)</div>
            <div class="signal-today" data-drop-zone="signal-today"></div>
        </div>
        <div class="signal-section">
            <div class="section-label">THIS WEEK</div>
            <div class="signal-week" data-drop-zone="signal-week"></div>
        </div>
    `;
    board.appendChild(signalColumn);

    // Add remaining columns
    board.appendChild(createColumn('NOISE', 'noise'));
    board.appendChild(createColumn('COMPLETED', 'completed'));
}

// Create column element
function createColumn(title, id) {
    const column = document.createElement('div');
    column.className = 'column';
    column.id = `column-${id}`;
    column.innerHTML = `
        <div class="column-header">
            <span class="column-title">${title}</span>
            <span class="column-count" id="count-${id}">0</span>
        </div>
        <div class="column-content" data-column="${id}"></div>
    `;
    return column;
}

// ============= API FUNCTIONS =============

// Load user cards from API
async function loadUserCards() {
    try {
        const response = await fetch(`${CONFIG.API_ENDPOINT}/cards/all`, {
            headers: getAuthHeaders()
        });
        
        if (!response.ok) {
            throw new Error('Failed to load cards');
        }
        
        const data = await response.json();
        
        // Clear existing cards
        document.querySelectorAll('.action-card').forEach(card => card.remove());
        
        // Add cards to appropriate columns
        data.cards.forEach(card => {
            addActionCard(card, card.column, card.quadrant);
        });
        
        updateStats();
        console.log(`Loaded ${data.cards.length} cards`);
    } catch (error) {
        console.error('Error loading cards:', error);
        showNotification('Failed to load cards', 'error');
    }
}

// Fetch missions from API
async function fetchMissions() {
    try {
        const missionContent = document.getElementById('missionContent');
        if (missionContent) {
            missionContent.innerHTML = '<div class="loading">Loading missions...</div>';
        }

        const token = localStorage.getItem(CONFIG.TOKEN_KEY) || sessionStorage.getItem(CONFIG.TOKEN_KEY);
        if (!token) {
            console.error('No auth token found');
            return;
        }

        const response = await fetch(`${CONFIG.API_ENDPOINT}/cards/missions`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: currentUser.email,  // Send the logged-in user's email
                userId: currentUser.id || currentUser.email
            })
        });

        if (!response.ok) throw new Error('Failed to fetch missions');

        const result = await response.json();
        if (result.success && result.data) {
            displayMissions(result.data);
            updateMissionStats(result.data);
        } else {
            throw new Error('Invalid missions payload');
        }
    } catch (error) {
        console.error('Error fetching missions:', error);
        showNotification('Failed to load missions', 'error');
        // Load sample missions as fallback
        loadSampleMissions();
    }
}

// Display missions
function displayMissions(data) {
    const missionContent = document.getElementById('missionContent');
    if (!missionContent) return;

    const qBanner = document.getElementById('quarterInfo');
    if (qBanner) {
        const quarterLabel = data.quarter || 'Q4 2025';
        const daysLeft = daysToQuarterEnd(quarterLabel);

        let displayText = '';
        if (daysLeft < 0) {
            displayText = `${quarterLabel} <span class="days">starts in ${Math.abs(daysLeft)} days</span>`;
        } else if (daysLeft > 0) {
            displayText = `${quarterLabel} <span class="days">${daysLeft} days left</span>`;
        } else {
            displayText = `${quarterLabel} <span class="days">ended</span>`;
        }
        
        qBanner.innerHTML = displayText;
    }

    let missionsHTML = '';
    if (data.domains && typeof data.domains === 'object') {
        Object.entries(data.domains).forEach(([key, domain]) => {
            missionsHTML += `
                <div class="mission-card">
                    <h3>${domain.icon || ''} ${domain.name || key}</h3>
                    ${(domain.missions || []).map(mission => `
                        <div class="mission-item">
                            <span class="mission-status ${(domain.onTrack ? 'status-progress' : 'status-not-started')}">
                                ${domain.onTrack ? '‚Üë' : '‚óã'}
                            </span>
                            <span>${mission}</span>
                        </div>
                    `).join('')}
                    ${domain.primaryMetric ? `
                        <div class="mission-metric">
                            <strong>${domain.primaryMetric}:</strong>
                            ${domain.currentValue ?? ''} / ${domain.targetValue ?? ''}
                            <div style="margin-top:.25rem;">
                                <div style="background:#333;height:4px;border-radius:2px;overflow:hidden;">
                                    <div style="
                                        background:${domain.onTrack ? 'var(--success-green)' : 'var(--warning-yellow)'};
                                        width:${Math.max(0, Math.min(100, Number(domain.progress) || 0))}%;
                                        height:100%;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        });
    }

    missionContent.innerHTML = missionsHTML || '<div class="loading">No missions found.</div>';
}

// Update mission stats
function updateMissionStats(data) {
    if (data.summary && data.summary.overallProgress !== undefined) {
        const q4Element = document.getElementById('q4Alignment');
        if (q4Element) q4Element.textContent = `${data.summary.overallProgress}%`;
    }
}

// Load sample missions as fallback
function loadSampleMissions() {
    const sampleData = {
        quarter: "Q4 2025",
        domains: {
            body: {
                name: "Body",
                icon: "üí™",
                missions: ["Eat healthy & drop 20lbs", "Visit sport Dr.", "Check T-levels"],
                onTrack: true,
                progress: 65
            },
            being: {
                name: "Being",
                icon: "üß†",
                missions: ["30min meditation 3x/week", "Follow me lesson prep", "Prayer Stack daily"],
                onTrack: true,
                progress: 80
            },
            balance: {
                name: "Balance",
                icon: "‚öñÔ∏è",
                missions: ["Date night weekly", "Kids 1-on-1 time", "Family vacation plan"],
                onTrack: false,
                progress: 45
            },
            business: {
                name: "Business",
                icon: "üíº",
                missions: ["Launch new product line", "Hire 2 key positions", "Revenue target $2M"],
                onTrack: true,
                progress: 70
            }
        },
        summary: {
            overallProgress: 65
        }
    };
    
    displayMissions(sampleData);
}

// ============= CARD MANAGEMENT =============

// Add action card to board
function addActionCard(action, column, zone = null) {
    const card = document.createElement('div');
    card.className = 'action-card';
    card.draggable = true;
    card.dataset.id = action.id;
    card.dataset.column = column;
    card.dataset.action = JSON.stringify(action);
    
    if (action.impact >= 90) {
        card.classList.add('high-impact');
    }

    let badgesHtml = '';
    if (action.tags && action.tags.length > 0) {
        action.tags.forEach(tag => {
            let badgeClass = 'badge';
            if (tag === 'Q4' || tag === 'Q4 Goal') badgeClass += ' badge-q4';
            if (tag === 'Urgent') badgeClass += ' badge-warning';
            if (tag === 'Delegatable' || tag === 'Delegated') badgeClass += ' badge-delegated';
            if (tag === 'High Impact') badgeClass += ' badge-warning';
            badgesHtml += `<span class="${badgeClass}">${tag}</span>`;
        });
    }

    badgesHtml += `<span class="badge badge-domain">${action.domain}</span>`;

    const deadlineText = action.deadline ? 
        `üìÖ ${new Date(action.deadline).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}` : '';

    card.innerHTML = `
        <div class="card-header">
            <div class="card-title">${action.title}</div>
            <div class="card-actions">
                <button class="card-btn" onclick="editAction('${action.id}')">‚úèÔ∏è</button>
                <button class="card-btn" onclick="quickDelete('${action.id}')">üóëÔ∏è</button>
            </div>
        </div>
        ${badgesHtml ? `<div class="card-badges">${badgesHtml}</div>` : ''}
        <div class="card-meta">
            <span class="card-effort">‚è±Ô∏è ${action.effort}h</span>
            ${action.q4Alignment ? `<span>Q4: ${action.q4Alignment}%</span>` : ''}
            <span class="card-score">‚≠ê ${action.impact}</span>
        </div>
        ${action.sourceSession ? `<div class="card-source">üîß Stack Session - ${action.sourceSession}</div>` : ''}
        ${deadlineText ? `<div class="card-source">${deadlineText}</div>` : ''}
    `;

    // Add to appropriate container
    let container;
    if (zone === 'signal-today' || zone === 'signal-week') {
        container = document.querySelector(`[data-drop-zone="${zone}"]`);
    } else if (zone && column === 'todo') {
        container = document.querySelector(`.section-${zone} .section-items`);
    } else {
        container = document.querySelector(`[data-column="${column}"]`);
        if (container.querySelector('.signal-today')) {
            container = container.querySelector('.signal-week');
        }
    }

    if (container) {
        container.appendChild(card);
        setupCardDragEvents(card);
    }
}

// Save action (create or update)
async function saveAction() {
    const title = document.getElementById('actionTitle').value.trim();
    if (!title) {
        showNotification('Title is required!', 'error');
        return;
    }

    const cardData = {
        title: title,
        description: document.getElementById('actionDescription').value,
        domain: document.getElementById('domainSelect').value,
        quadrant: document.getElementById('quadrantSelect').value,
        effort: parseFloat(document.getElementById('effortHours').value) || 1,
        impact: parseInt(document.getElementById('impactScore').value) || 5,
        q4Alignment: parseInt(document.getElementById('q4Score').value) || 50,
        deadline: document.getElementById('deadline').value || null,
        sourceSession: document.getElementById('sourceSession').value || '',
        tags: getSelectedTags()
    };

    try {
        if (currentEditingCard) {
            // Update existing card
            const oldAction = JSON.parse(currentEditingCard.dataset.action);
            cardData.id = oldAction.id;
            
            const response = await fetch(`${CONFIG.API_ENDPOINT}/cards/update`, {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(cardData)
            });
            
            if (!response.ok) throw new Error('Failed to update card');
            
            // Update the card in the UI
            currentEditingCard.remove();
            addActionCard({...oldAction, ...cardData}, currentEditingCard.dataset.column, oldAction.quadrant);
            showNotification('Action updated successfully!');
        } else {
            // Create new card
            const response = await fetch(`${CONFIG.API_ENDPOINT}/cards/add`, {
                method: 'POST',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(cardData)
            });
            
            if (!response.ok) throw new Error('Failed to save card');
            
            const result = await response.json();
            if (result.success) {
                addActionCard(result.card, 'todo', result.card.quadrant || 'ui');
                showNotification('Card added successfully!');
            }
        }
        
        closeEditModal();
        updateStats();
    } catch (error) {
        console.error('Error saving card:', error);
        showNotification('Failed to save card', 'error');
    }
}

// Delete current action
async function deleteCurrentAction() {
    if (!currentEditingCard) return;
    
    if (confirm('Are you sure you want to delete this action?')) {
        const actionId = JSON.parse(currentEditingCard.dataset.action).id;
        const success = await deleteCard(actionId);
        
        if (success) {
            currentEditingCard.remove();
            updateStats();
            closeEditModal();
            showNotification('Action deleted!');
        } else {
            showNotification('Failed to delete action', 'error');
        }
    }
}

// Quick delete action
async function quickDelete(id) {
    if (!confirm('Delete this action?')) return;
    
    const card = document.querySelector(`[data-id="${id}"]`);
    if (!card) return;
    
    const success = await deleteCard(id);
    if (success) {
        card.remove();
        updateStats();
        showNotification('Action deleted!');
    } else {
        showNotification('Failed to delete action', 'error');
    }
}

// ============= UI FUNCTIONS =============

// Open quick capture modal
function openQuickCapture() {
    currentEditingCard = null;
    document.getElementById('modalTitle').textContent = '‚ö° Quick Capture';
    document.getElementById('deleteBtn').style.display = 'none';
    clearForm();
    document.getElementById('editModal').classList.add('active');
    document.getElementById('actionTitle').focus();
}

// Edit action
function editAction(id) {
    const card = document.querySelector(`[data-id="${id}"]`);
    if (!card) return;

    currentEditingCard = card;
    const action = JSON.parse(card.dataset.action);

    document.getElementById('modalTitle').textContent = '‚úèÔ∏è Edit Action';
    document.getElementById('deleteBtn').style.display = 'block';

    document.getElementById('actionTitle').value = action.title || '';
    document.getElementById('actionDescription').value = action.description || '';
    document.getElementById('domainSelect').value = action.domain || 'Business';
    document.getElementById('quadrantSelect').value = action.quadrant || 'uni';
    document.getElementById('effortHours').value = action.effort || '';
    document.getElementById('impactScore').value = action.impact || '';
    document.getElementById('q4Score').value = action.q4Alignment || '';
    document.getElementById('deadline').value = action.deadline ? action.deadline.split('T')[0] : '';
    document.getElementById('sourceSession').value = action.sourceSession || '';
    document.getElementById('revelation').value = '';

    document.querySelectorAll('.tag-btn').forEach(btn => {
        btn.classList.remove('active');
        if (action.tags && action.tags.includes(btn.textContent)) {
            btn.classList.add('active');
        }
    });

    document.getElementById('editModal').classList.add('active');
}

// Close edit modal
function closeEditModal() {
    document.getElementById('editModal').classList.remove('active');
    currentEditingCard = null;
    clearForm();
}

// Clear form
function clearForm() {
    document.getElementById('actionTitle').value = '';
    document.getElementById('actionDescription').value = '';
    document.getElementById('domainSelect').value = 'Business';
    document.getElementById('quadrantSelect').value = 'ui';
    document.getElementById('effortHours').value = '';
    document.getElementById('impactScore').value = '';
    document.getElementById('q4Score').value = '';
    document.getElementById('deadline').value = '';
    document.getElementById('sourceSession').value = '';
    document.getElementById('revelation').value = '';
    
    document.querySelectorAll('.tag-btn').forEach(btn => {
        btn.classList.remove('active');
    });
}

// Toggle tag selection
function toggleTag(button) {
    button.classList.toggle('active');
}

// Toggle missions section
function toggleMissions() {
    const content = document.getElementById('missionContent');
    const btn = document.getElementById('collapseBtn');
    
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        btn.textContent = '‚åÉ';
    } else {
        content.classList.add('collapsed');
        btn.textContent = '‚åÑ';
    }
}

// Toggle stats bar
function toggleStats() {
    const statsBar = document.getElementById('statsBar');
    if (statsBar.style.display === 'none') {
        statsBar.style.display = 'flex';
    } else {
        statsBar.style.display = 'none';
    }
}

// Show notification
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification show ${type}`;
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// Refresh data
function refreshData() {
    showNotification('Refreshing data...', 'info');
    
    Promise.all([
        loadUserCards(),
        fetchMissions()
    ]).then(() => {
        updateFooterSync();
        showNotification('Data refreshed successfully!', 'success');
    }).catch(error => {
        console.error('Error refreshing data:', error);
        showNotification('Failed to refresh some data', 'error');
    });
}

// ============= DRAG AND DROP =============

let draggedElement = null;

function setupCardDragEvents(card) {
    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragend', handleDragEnd);
}

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.column').forEach(col => {
        col.classList.remove('drag-over');
    });
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    const column = this.closest('.column');
    if (column) {
        column.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    const column = this.closest('.column');
    if (column && !column.contains(e.relatedTarget)) {
        column.classList.remove('drag-over');
    }
}

async function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }

    const column = this.closest('.column');
    if (column) {
        column.classList.remove('drag-over');
    }

    if (draggedElement && draggedElement !== this) {
        let targetColumn = this.dataset.column;
        let targetZone = this.dataset.dropZone;

        if (!targetColumn) {
            const col = this.closest('.column');
            if (col) {
                targetColumn = col.id.replace('column-', '');
            }
        }

        // Check capacity constraints for IN ACTION
        if (targetColumn === 'inaction') {
            if (!checkCapacity(draggedElement)) {
                if (!confirm('This will exceed your 40-hour capacity. Continue anyway?')) {
                    return false;
                }
            }
        }
        
        // Check SIGNAL today limit
        if (targetZone === 'signal-today') {
            const todayCount = document.querySelectorAll('[data-drop-zone="signal-today"] .action-card').length;
            if (todayCount >= 3 && !this.contains(draggedElement)) {
                showNotification('Today section full! Maximum 3 items.', 'error');
                return false;
            }
        }

        // Move the card in UI
        if (targetZone) {
            this.appendChild(draggedElement);
        } else if (this.classList.contains('section-items')) {
            this.appendChild(draggedElement);
        } else if (this.classList.contains('column-content')) {
            if (targetColumn === 'todo') {
                const firstQuadrant = this.querySelector('.section-items');
                if (firstQuadrant) {
                    firstQuadrant.appendChild(draggedElement);
                }
            } else if (this.querySelector('.signal-week')) {
                this.querySelector('.signal-week').appendChild(draggedElement);
            } else {
                this.appendChild(draggedElement);
            }
        }

        // Update the card's data
        draggedElement.dataset.column = targetColumn;
        
        // Sync with backend
        const cardId = draggedElement.dataset.id;
        const action = JSON.parse(draggedElement.dataset.action);
        const newQuadrant = targetZone ? targetZone.replace('todo-', '') : action.quadrant;
        
        await syncCardMove(cardId, targetColumn, newQuadrant);
        
        updateColumnCounts();
        updateCapacityBar();
        showNotification('Action moved successfully!');
    }

    return false;
}

// ============= STATS AND CAPACITY =============

function checkCapacity(card) {
    const currentCapacity = getCurrentCapacity();
    const cardAction = JSON.parse(card.dataset.action);
    return (currentCapacity + (cardAction.effort || 0)) <= 40;
}

function getCurrentCapacity() {
    let totalHours = 0;
    document.querySelectorAll('#column-inaction .action-card').forEach(card => {
        const action = JSON.parse(card.dataset.action);
        totalHours += action.effort || 0;
    });
    return totalHours;
}

function updateCapacityBar() {
    const totalHours = getCurrentCapacity();
    const percentage = (totalHours / 40) * 100;
    const fill = document.getElementById('capacityFill');
    
    fill.style.width = Math.min(percentage, 100) + '%';
    fill.querySelector('.capacity-text').textContent = `${totalHours.toFixed(1)}/40 hrs`;

    fill.className = 'capacity-fill';
    if (percentage > 90) {
        fill.classList.add('danger');
    } else if (percentage > 70) {
        fill.classList.add('warning');
    } else {
        fill.classList.add('safe');
    }

    document.getElementById('weeklyCapacity').textContent = `${totalHours.toFixed(1)}/40 hrs`;
}

function updateColumnCounts() {
    ['todo', 'inaction', 'signal', 'noise', 'completed'].forEach(col => {
        const count = document.querySelectorAll(`#column-${col} .action-card`).length;
        document.getElementById(`count-${col}`).textContent = count;
    });

    const todayCount = document.querySelectorAll('[data-drop-zone="signal-today"] .action-card').length;
    document.getElementById('todayFocus').textContent = `${todayCount}/3 items`;
}

function updateStats() {
    updateColumnCounts();
    updateCapacityBar();
    
    // Calculate Q4 alignment
    let totalQ4 = 0;
    let q4Count = 0;
    document.querySelectorAll('.action-card').forEach(card => {
        const action = JSON.parse(card.dataset.action);
        if (action.q4Alignment) {
            totalQ4 += action.q4Alignment;
            q4Count++;
        }
    });
    const avgQ4 = q4Count > 0 ? Math.round(totalQ4 / q4Count) : 0;
    document.getElementById('q4Alignment').textContent = `${avgQ4}%`;
    
    // Calculate completion rate
    const completed = document.querySelectorAll('#column-completed .action-card').length;
    const total = document.querySelectorAll('.action-card').length;
    const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
    document.getElementById('completionRate').textContent = `${completionRate}%`;
}

// ============= EVENT LISTENERS =============

function setupEventListeners() {
    // Drag and drop zones
    document.querySelectorAll('.column-content, [data-drop-zone], .section-items').forEach(zone => {
        zone.addEventListener('dragover', handleDragOver);
        zone.addEventListener('drop', handleDrop);
        zone.addEventListener('dragleave', handleDragLeave);
        zone.addEventListener('dragenter', handleDragEnter);
    });

    // Keyboard shortcuts
    setupKeyboardShortcuts();
    
    // Session timeout
    resetSessionTimer();
}

function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Ctrl/Cmd + Space for Quick Capture
        if ((e.ctrlKey || e.metaKey) && e.key === ' ') {
            e.preventDefault();
            openQuickCapture();
        }
        
        // Escape to close modal
        if (e.key === 'Escape') {
            closeEditModal();
        }
    });
}

// Session timeout management
function resetSessionTimer() {
    clearTimeout(sessionTimeout);
    clearTimeout(warningTimeout);
    
    // Warning after 25 minutes
    warningTimeout = setTimeout(() => {
        if (confirm('Your session will expire in 5 minutes. Do you want to continue?')) {
            resetSessionTimer();
        }
    }, 25 * 60 * 1000);
    
    // Auto logout after 30 minutes
    sessionTimeout = setTimeout(() => {
        showNotification('Session expired. Please login again.', 'error');
        setTimeout(logout, 2000);
    }, 30 * 60 * 1000);
}

// Reset timer on any user activity
document.addEventListener('click', resetSessionTimer);
document.addEventListener('keypress', resetSessionTimer);
document.addEventListener('mousemove', resetSessionTimer);

// ============= INITIALIZATION ON PAGE LOAD =============

document.addEventListener('DOMContentLoaded', function() {
    // First check if user came from dashboard
    if (!checkDashboardAuth()) {
        // If not from dashboard, check local authentication
        checkAuthentication();
    }
});

// Auto-save every 30 seconds
setInterval(() => {
    if (currentUser && authToken) {
        saveBoardData();
        updateFooterSync();
    }
}, 30000);

// Save before user leaves
window.addEventListener('beforeunload', () => {
    if (currentUser && authToken) {
        saveBoardData();
        updateFooterSync();
    }
});

// Handle responsive board layout
function handleResponsiveBoard() {
    const width = window.innerWidth;
    const board = document.getElementById('board');
    
    if (width < 768) {
        board.style.flexDirection = 'column';
    } else {
        board.style.flexDirection = 'row';
    }
}

window.addEventListener('resize', handleResponsiveBoard);
handleResponsiveBoard();

// Debug mode
if (CONFIG.DEBUG) {
    window.debugBoard = {
        boardData,
        currentUser,
        authToken,
        getStats: () => {
            return {
                total: document.querySelectorAll('.action-card').length,
                completed: document.querySelectorAll('#column-completed .action-card').length,
                capacity: getCurrentCapacity()
            };
        },
        clearAll: () => {
            if (confirm('Clear all cards?')) {
                document.querySelectorAll('.action-card').forEach(card => card.remove());
                updateStats();
            }
        }
    };
    console.log('Debug mode enabled. Access debug tools via window.debugBoard');
}
</script>
</body>
</html>
